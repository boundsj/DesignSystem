---
description: Sync color variables from Figma to Swift
globs: 
alwaysApply: false
---

# Figma Color Sync

When the user asks to "sync Figma colors" or similar:

## Prerequisites
- User must have the Design Library file open in Figma Desktop (not browser)
- File: https://www.figma.com/design/EY4dEkIjYNcF793t6O1koW/Design-Library

## IMPORTANT: Full Regeneration Required

Every sync MUST regenerate ALL assets from scratch. Do not skip any step or assume files exist.
- ALWAYS regenerate ALL colorset Contents.json files (both primitives and semantics)
- ALWAYS regenerate DSColor.swift completely
- Create any missing directories (semantic/, semantic/background/, etc.)
- The sync must be idempotent: running it twice should produce identical results

## Steps

1. **Fetch variables from Figma** using the MCP tool:
   ```
   Server: user-Figma Desktop
   Tool: get_variable_defs
   Arguments: {"nodeId": "0:1", "fileKey": "EY4dEkIjYNcF793t6O1koW", "clientLanguages": "swift", "clientFrameworks": "swiftui"}
   ```

2. **Parse the response** - it returns a flat object like:
   ```json
   {
     "slate/50": "#F8FAFC",
     "background/primary": "#f8fafc"
   }
   ```

3. **Categorize variables**:
   - **Primitives**: Match pattern `{palette}/{shade}` where shade is numeric (e.g., `slate/50`)
   - **Semantics**: Match pattern `{category}/{name}` where category is `background`, `text`, or `border`

4. **Generate xcassets** (ALWAYS regenerate, even if files exist):

   **For Primitives** (no dark mode):
   - Create directory if missing: `Sources/DesignSystem/Resources/Colors.xcassets/primitive/{palette}/{shade}.colorset/`
   - Write `Contents.json` with single appearance (universal)
   - Convert hex to RGB floats (divide by 255, format to 3 decimal places)

   **For Semantics** (with dark mode):
   - Create directories if missing: `Sources/DesignSystem/Resources/Colors.xcassets/semantic/` and `semantic/{category}/`
   - Add `Contents.json` to each directory with `provides-namespace: true` (required for path-based loading):
     ```json
     {
       "info": { "author": "xcode", "version": 1 },
       "properties": { "provides-namespace": true }
     }
     ```
   - Create `semantic/{category}/{name}.colorset/Contents.json`
   - Dual appearances: universal (light) + dark
   - Derive dark mode value using inverse slate mapping (see below)
   - Match the light hex to a primitive, then use the inverse primitive's RGB values for dark

5. **Generate DSColor.swift** at `Sources/DesignSystem/Tokens/DSColor.swift`:
   - Include "DO NOT EDIT" header
   - Primitives: Group by palette (e.g., `DSColor.Slate.s50`)
   - Semantics: Group by category (e.g., `DSColor.Background.primary`)
   - Include private `DSColorAssetName` enum and `Color.dsAsset()` extension

6. **Verify generation** by running build and tests:
   ```bash
   swift build && swift test
   ```
   - Build must succeed (validates xcassets and DSColor.swift syntax)
   - All tests must pass (validates color tokens are accessible at runtime)
   - If tests fail, check that DSColor.swift matches what tests expect (see Test Reference below)

## Dark Mode Inverse Mapping

The Figma API returns light mode values. Derive dark mode by matching to a primitive and using the inverse:

| Light (Primitive) | Dark (Inverse) |
|-------------------|----------------|
| slate/50          | slate/900      |
| slate/100         | slate/800      |
| slate/200         | slate/700      |
| slate/300         | slate/600      |
| slate/400         | slate/500      |
| slate/500         | slate/400      |
| slate/600         | slate/300      |
| slate/700         | slate/200      |
| slate/800         | slate/100      |
| slate/900         | slate/50       |

## Colorset JSON Formats

**Primitive (single appearance):**
```json
{
  "colors": [
    {
      "color": {
        "color-space": "srgb",
        "components": { "alpha": "1.000", "blue": "0.988", "green": "0.980", "red": "0.973" }
      },
      "idiom": "universal"
    }
  ],
  "info": { "author": "xcode", "version": 1 }
}
```

**Semantic (light + dark appearances):**
```json
{
  "colors": [
    {
      "color": {
        "color-space": "srgb",
        "components": { "alpha": "1.000", "blue": "...", "green": "...", "red": "..." }
      },
      "idiom": "universal"
    },
    {
      "appearances": [{ "appearance": "luminosity", "value": "dark" }],
      "color": {
        "color-space": "srgb",
        "components": { "alpha": "1.000", "blue": "...", "green": "...", "red": "..." }
      },
      "idiom": "universal"
    }
  ],
  "info": { "author": "xcode", "version": 1 }
}
```

## Color Path Conventions

| Figma Variable       | Asset Path                    | Swift API                   |
|---------------------|-------------------------------|-----------------------------|
| `slate/50`          | `primitive/slate/50`          | `DSColor.Slate.s50`         |
| `background/primary`| `semantic/background/primary` | `DSColor.Background.primary`|
| `text/primary`      | `semantic/text/primary`       | `DSColor.Text.primary`      |
| `border/default`    | `semantic/border/default`     | `DSColor.Border.default`    |

## After Sync
- Build and tests must pass (step 6)
- The DSColorPreview.swift file may need manual updates if new palettes/semantics are added

## Test Reference

Tests are located at `Tests/DesignSystemTests/DesignSystemTests.swift`. They validate:

| Test | What it checks |
|------|----------------|
| `testColorTokensCompile` | DSColor.Slate tokens are accessible |
| `testSlateColorsPresentAndType` | All slate primitives (s50â€“s900) exist and are `Color` type |
| `testBackgroundColorsPresentAndType` | All background semantics (primary, secondary, tertiary) exist and are `Color` type |

**If you add new semantic categories** (e.g., `text/*`, `border/*`), you should also add corresponding tests.

**If tests fail after sync:**
1. Check that DSColor.swift was generated with all expected tokens
2. Check that colorset directories exist with valid Contents.json files
3. Ensure the test expectations match the Figma variables
